<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The zcashd Book</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">zcashd</a></li><li class="chapter-item expanded "><a href="user.html"><strong aria-hidden="true">1.</strong> User Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="user/metrics.html"><strong aria-hidden="true">1.1.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="user/deprecation.html"><strong aria-hidden="true">1.2.</strong> Deprecated Features</a></li></ol></li><li class="chapter-item expanded "><a href="dev.html"><strong aria-hidden="true">2.</strong> Developer Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dev/rust.html"><strong aria-hidden="true">2.1.</strong> Rust in zcashd</a></li><li class="chapter-item expanded "><a href="dev/regtest.html"><strong aria-hidden="true">2.2.</strong> Regtest tips and hints</a></li><li class="chapter-item expanded "><a href="dev/deprecation.html"><strong aria-hidden="true">2.3.</strong> Deprecation Procedure</a></li></ol></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="design/chain-state.html"><strong aria-hidden="true">3.1.</strong> Chain state</a></li><li class="chapter-item expanded "><a href="design/coins-view.html"><strong aria-hidden="true">3.2.</strong> "Coins" view</a></li><li class="chapter-item expanded "><a href="design/p2p-data-propagation.html"><strong aria-hidden="true">3.3.</strong> P2P data propagation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The zcashd Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="build-from-source-sidechain-version"><a class="header" href="#build-from-source-sidechain-version">Build from Source (Sidechain Version)</a></h3>
<p>To install all dependencies and build zcash-sidechain on ubuntu (22.04) run:</p>
<pre><code>sudo apt-get update
sudo apt-get upgrade
sudo apt-get install git curl
# install nix package manager
sh &lt;(curl -L https://nixos.org/nix/install) --daemon
# now follow the instructions and then close and open the terminal (to get nix initialized)
git clone git@github.com:nchashch/zcash-sidechain.git
cd zcash-sidechain
nix-shell # this will install all build tools and dependencies
./autogen.sh
./configure $configureFlags
make -j8 # or number of cores you want to use
</code></pre>
<h3 id="regtest-demo-script"><a class="header" href="#regtest-demo-script">Regtest Demo Script</a></h3>
<p>A script for: activating this sidechain (on <a href="https://github.com/drivechain-project/mainchain/">drivechain</a>), mining blocks, depositing and withdrawing coins, generating t/z addresses and using them, is <a href="zside-tour-2022.sh">available here</a>.</p>
<hr />
<h1>Zcash 5.0.0
<img align="right" width="120" height="80" src="doc/imgs/logo.png"></h1>
<h2 id="what-is-zcash"><a class="header" href="#what-is-zcash">What is Zcash?</a></h2>
<p><a href="https://z.cash/">Zcash</a> is an implementation of the &quot;Zerocash&quot; protocol.
Based on Bitcoin's code, Zcash intends to offer a far higher standard of privacy
through a sophisticated zero-knowledge proving scheme that preserves
confidentiality of transaction metadata. More technical details are available
in our <a href="https://zips.z.cash/protocol/protocol.pdf">Protocol Specification</a>.</p>
<p>This software is the Zcash client. It downloads and stores the entire history
of Zcash transactions; depending on the speed of your computer and network
connection, the synchronization process could take a day or more once the
blockchain has reached a significant size.</p>
<p align="center">
  <img src="doc/imgs/zcashd_screen.gif" height="500">
</p>
<h4 id="lock-security-warnings"><a class="header" href="#lock-security-warnings">:lock: Security Warnings</a></h4>
<p>See important security warnings on the
<a href="https://z.cash/support/security/">Security Information page</a>.</p>
<p><strong>Zcash is experimental and a work in progress.</strong> Use it at your own risk.</p>
<h4 id="ledger-deprecation-policy"><a class="header" href="#ledger-deprecation-policy">:ledger: Deprecation Policy</a></h4>
<p>This release is considered deprecated 16 weeks after the release day. There
is an automatic deprecation shutdown feature which will halt the node some
time after this 16-week period. The automatic feature is based on block
height.</p>
<h4 id="need-help"><a class="header" href="#need-help">Need Help?</a></h4>
<ul>
<li>:blue_book: See the documentation at the <a href="https://zcash.readthedocs.io">ReadTheDocs</a>
for help and more information.</li>
<li>:incoming_envelope: Ask for help on the <a href="https://forum.z.cash/">Zcash</a> forum.</li>
<li>:speech_balloon: Join our community on <a href="https://discordapp.com/invite/PhJY6Pm">Discord</a></li>
</ul>
<p>Participation in the Zcash project is subject to a
<a href="code_of_conduct.html">Code of Conduct</a>.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>For license information see the file <a href="COPYING">COPYING</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-documentation"><a class="header" href="#user-documentation">User Documentation</a></h1>
<p>This section contains user documentation specific to <code>zcashd</code>.</p>
<p>See <a href="https://zcash.readthedocs.io/">here</a> for more general Zcash documentation, as well as
installation instructions for <code>zcashd</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="zcashd-metrics"><a class="header" href="#zcashd-metrics">zcashd metrics</a></h1>
<h2 id="metrics-ui"><a class="header" href="#metrics-ui">Metrics UI</a></h2>
<p>This is the user interface that <code>zcashd</code> displays by default when run. It
displays a small selection of interesting metrics, but is not intended for
programmatic consumption.</p>
<h2 id="rpc-methods"><a class="header" href="#rpc-methods">RPC methods</a></h2>
<p><code>zcashd</code> provides the following JSON-RPC methods that expose node metrics:</p>
<ul>
<li>Chain:
<ul>
<li><code>getblockchaininfo</code>: Various state info regarding block chain processing.</li>
<li><code>gettxoutsetinfo</code>: Statistics about the unspent transparent transaction output set.</li>
<li><code>getmempoolinfo</code>: Details on the active state of the TX memory pool.</li>
</ul>
</li>
<li>P2P network:
<ul>
<li><code>getnetworkinfo</code>: Various state info regarding P2P networking.</li>
<li><code>getpeerinfo</code>: Data about each connected network node.</li>
<li><code>getdeprecationinfo</code>: The current node version and deprecation block height.</li>
</ul>
</li>
<li>Miscellaneous
<ul>
<li><code>getmemoryinfo</code>: Information about memory usage.</li>
<li><code>getmininginfo</code>: Mining-related information.</li>
<li><code>getinfo</code> (deprecated): A small subset of the above metrics.</li>
</ul>
</li>
</ul>
<p>You can see what each method provides with <code>zcash-cli help METHOD_NAME</code>.</p>
<h2 id="prometheus-support"><a class="header" href="#prometheus-support">Prometheus support</a></h2>
<p><code>zcashd</code> can optionally expose an HTTP server that acts as a Prometheus scrape
endpoint. The server will respond to <code>GET</code> requests on any request path.</p>
<p>To enable the endpoint, add <code>-prometheusport=&lt;port&gt;</code> to your <code>zcashd</code>
configuration (either in <code>zcash.conf</code> or on the command line). After
restarting <code>zcashd</code> you can then test the endpoint by querying it:</p>
<pre><code>$ curl http://127.0.0.1:&lt;port&gt;
# TYPE zcash_net_out_messages counter
zcash_net_out_messages 181

# TYPE zcash_net_in_bytes_total counter
zcash_net_in_bytes_total 3701998

# TYPE zcash_net_in_messages counter
zcash_net_in_messages 184

# TYPE zcashd_build_info counter
zcashd_build_info{version=&quot;v4.2.0&quot;} 1

# TYPE zcash_chain_verified_block_total counter
zcash_chain_verified_block_total 162
...
</code></pre>
<p>By default, access is restricted to localhost. This can be expanded with
<code>-metricsallowip=&lt;ip&gt;</code>, which can specify IPs or subnets. Note that HTTPS is not
supported, and therefore connections to the endpoint are not encrypted or
authenticated. Access to the endpoint should be assumed to compromise the
privacy of node operations, by the provided metrics and/or by timing side
channels. Non-localhost access is <strong>strongly discouraged</strong> if the node has a
wallet holding live funds.</p>
<h3 id="example-metrics-collection-with-docker"><a class="header" href="#example-metrics-collection-with-docker">Example metrics collection with Docker</a></h3>
<p>The example instructions below were tested on Windows 10 using Docker Desktop
with the WSL 2 backend, connected to a <code>zcashd</code> running inside WSL2 (but not
inside Docker):</p>
<pre><code># Create a storage volume for Grafana (once)
docker volume create grafana-storage

# Create a storage volume for Prometheus (once)
docker volume create prometheus-storage

# Run Prometheus
# You will need to modify ~/contrib/metrics/prometheus.yaml to match the
# port configured with -prometheusport and -metricsbind / -metricsallowip
# (and possibly also for your Docker network setup).
docker run --detach -p 9090:9090 --volume prometheus-storage:/prometheus --volume ~/contrib/metrics/prometheus.yaml:/etc/prometheus/prometheus.yml  prom/prometheus

# Run Grafana
docker run --detach -p 3030:3030 --env GF_SERVER_HTTP_PORT=3030 --volume grafana-storage:/var/lib/grafana grafana/grafana
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deprecated-features"><a class="header" href="#deprecated-features">Deprecated Features</a></h1>
<p>In order to support the continuous improvement of <code>zcashd</code>, features are
periodically deprecated and removed when they have been superseded or are no
longer useful.  Deprecation follows a 3-stage process:</p>
<ol>
<li>Initially, a feature will be marked as DEPRECATED in the release notes and
user-facing documentation, but no other changes are made; the feature
continues to be available and function as normal. While features at this
stage remain enabled by default, they may be explicitly disabled by
specifying <code>-allowdeprecated=none</code> on the command line when starting the
node, or by including <code>allowdeprecated=none</code> as a line in the <code>zcash.conf</code>
file. </li>
<li>In the next stage of deprecation, the feature will be disabled by default.
Disabled features may be reenabled via use of the <code>-allowdeprecated</code> flag.</li>
<li>In the third stage, the feature is fully removed and is no longer available.</li>
</ol>
<p>Features that enter Stage 1 in a particular release will be disabled by default
after no fewer than 3 releases that update <code>zcashd</code>'s minor-version, and
features will only be fully removed after a total of at least 6 minor-version updates.
<code>zcashd</code>'s release schedule intends to produce a release that updates the minor
version every 6 weeks, so deprecated features remain accessible by default for
approximately 18 weeks, and then can be expected to be removed no less than 36
weeks after their initial deprecation. Deprecation and removal timelines might
be extended beyond this on a case-by-case basis to satisfy user requirements. </p>
<h1 id="currently-deprecated"><a class="header" href="#currently-deprecated">Currently Deprecated</a></h1>
<h2 id="stage-1"><a class="header" href="#stage-1">Stage 1</a></h2>
<p>The following features are deprecated, but remain enabled by default. These features
will be disabled if <code>-allowdeprecated=none</code> is added to the CLI arguments when starting
the node, or if an <code>allowdeprecated=none</code> line is added to <code>zcash.conf</code>.</p>
<h3 id="deprecated-in-500"><a class="header" href="#deprecated-in-500">Deprecated in 5.0.0</a></h3>
<p>The following features are deprecated as of release 5.0.0 and will be disabled by
default as of release 5.3.0.</p>
<ul>
<li><code>legacy_privacy</code> - The default &quot;legacy&quot; privacy policy for z_sendmany is
deprecated. Use <code>-allowdeprecated=none</code> to require the default behavior to
conform to the <code>FullPrivacy</code> directive in all cases instead of just for
transactions involving unified addresses. </li>
<li><code>getnewaddress</code> - The <code>getnewaddress</code> RPC method is deprecated.</li>
<li><code>getrawchangeaddress</code> - The <code>getrawchangeaddress</code> RPC method is deprecated.</li>
<li><code>z_getbalance</code> - The <code>z_getbalance</code> RPC method is deprecated.</li>
<li><code>z_gettotalbalance</code> - The <code>z_gettotalbalance</code> RPC method is deprecated.</li>
<li><code>z_getnewaddress</code> - The <code>z_getnewaddress</code> RPC method is deprecated.</li>
<li><code>z_listaddresses</code> - The <code>z_listaddresses</code> RPC method is deprecated.</li>
<li><code>addrtype</code> - The <code>type</code> attribute is deprecated in the results of RPC
methods that return address metadata. It is recommended that applications
using this metadata be updated to use the <code>pool</code> or <code>address_type</code>
attributes, which have replaced the <code>type</code> attribute, as appropriate.</li>
</ul>
<h2 id="stage-2"><a class="header" href="#stage-2">Stage 2</a></h2>
<p>Each feature in the lists below may be enabled by adding <code>-allowdeprecated=&lt;feature&gt;</code>
to the CLI arguments when starting the node, or by adding an <code>allowdeprecated=&lt;feature&gt;</code>
line to <code>zcash.conf</code>.</p>
<h3 id="disabled-in-500"><a class="header" href="#disabled-in-500">Disabled in 5.0.0</a></h3>
<p>The following features are disabled by default, and will be removed in release 5.3.0.</p>
<ul>
<li><code>zcrawreceive</code> - The <code>zcrawreceive</code> RPC method is disabled.</li>
<li><code>zcrawjoinsplit</code> - The <code>zcrawjoinsplit</code> RPC method is disabled.</li>
<li><code>zcrawkeygen</code> - The <code>zcrawkeygen</code> RPC method is disabled.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-documentation"><a class="header" href="#developer-documentation">Developer Documentation</a></h1>
<p>This section contains documentation aimed at contributors to the <code>zcashd</code> codebase.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-in-zcashd"><a class="header" href="#rust-in-zcashd">Rust in <code>zcashd</code></a></h1>
<p><code>zcashd</code> is primarily a C++ codebase, but most new code is being written in Rust
where possible.</p>
<h2 id="adding-new-dependencies-in-online-rust-mode"><a class="header" href="#adding-new-dependencies-in-online-rust-mode">Adding new dependencies in online-Rust mode</a></h2>
<p>The <code>zcashd</code> build system pins all dependencies, and in order to facilitate
deterministic builds, <code>cargo</code> is configured to run in offline mode with vendored
crates. This means that if, for example, you add the <code>foobar</code> crate to
<code>Cargo.toml</code>, you will likely see an error similar to this:</p>
<pre><code>$ cargo check
error: no matching package named `foobar` found
location searched: registry `https://github.com/rust-lang/crates.io-index`
required by package `librustzcash v0.2.0 (/path/to/zcash)`
</code></pre>
<p>Instead, you first need to build <code>zcashd</code> in online-Rust mode:</p>
<pre><code>CONFIGURE_FLAGS=--enable-online-rust ./zcutil/build.sh
</code></pre>
<p>After doing so, you can add a new dependency as follows:</p>
<ol>
<li>Add the new dependency to <code>Cargo.toml</code>.</li>
<li>Run <code>cargo check</code> to update the <code>Cargo.lock</code> file.</li>
<li>Commit <code>Cargo.toml</code> and <code>Cargo.lock</code>.</li>
</ol>
<h2 id="using-a-local-rust-dependency"><a class="header" href="#using-a-local-rust-dependency">Using a local Rust dependency</a></h2>
<p>During development, you can use a locally checked out version of a dependency
by applying a <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html#the-patch-section"><code>cargo</code> patch</a>.</p>
<p>For example, to use a local version of the <code>orchard</code> crate that includes a new
API, add the following patch to <code>Cargo.toml</code>:</p>
<pre><code>[dependencies]
# This dependency is listed with a version, meaning it comes from crates.io; the
# patch goes into a [patch.crates-io] section.
orchard = &quot;0.0&quot;
...

[patch.crates-io]
# Comment out any existing patch, if present.
# orchard = { git = &quot;https://github.com/zcash/orchard.git&quot;, rev = &quot;...&quot; }

# Add this patch (both relative and absolute paths work):
orchard = { path = &quot;../relative/path/to/orchard&quot; }
</code></pre>
<p>Usually you can apply a patch to use a locally checked out dependency without
needing to build <code>zcashd</code> in online-Rust mode. However, if your local changes
include a new dependency, you will need to ensure you are in online-Rust mode.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="regtest"><a class="header" href="#regtest">Regtest</a></h1>
<p><em>Regtest</em> (&quot;regression test&quot;) is one of the three <em>network types</em>
supported by Zcash, the others being <code>testnet</code> and <code>mainnet</code>.
Regtest is an entirely local, self-contained mode -- your node or nodes
do not talk with peers out in the world. It gives you complete
control of the state of the blockchain and the sequence of events.
You start with an empty blockchain (just the genesis block, block 0).
Blocks can be mined instantly, and must be created explicitly. </p>
<p>You can run one or more regtest nodes on the same system.
The <a href="https://github.com/zcash/zcash/tree/master/qa/rpc-tests">RPC tests</a>
use <code>regtest</code> mode (usually starting multiple nodes), but you may use it
manually and interactively to learn, test, and experiment. Most often
just one node is used in this case.</p>
<h2 id="example-session"><a class="header" href="#example-session">Example session</a></h2>
<p>Here's a sample session (after you've built <code>zcashd</code> and <code>zcash-cli</code>):</p>
<pre><code>$ mkdir /tmp/regtest-datadir
$ cat &lt;&lt;EOF &gt;/tmp/regtest-datadir/zcash.conf
regtest=1
rpcuser=u
rpcpassword=p
rpcport=18132
EOF
$ src/zcashd -daemon -datadir=/tmp/regtest-datadir
</code></pre>
<p>Watch <code>tmp/regtest-datadir/regtest/debug.log</code> to see what <code>zcashd</code> is doing.
It may also be useful to start <code>zcashd</code> with <code>-debug</code> to generate much
more logging. Now we can send RPCs to the node:</p>
<pre><code>$ src/zcash-cli -datadir=/tmp/regtest-datadir getblockchaininfo
{
  &quot;chain&quot;: &quot;regtest&quot;,
  &quot;blocks&quot;: 0,
  &quot;initial_block_download_complete&quot;: false,
  &quot;headers&quot;: 0,
  (...)
}
# Generate (mine) three blocks:
$ src/zcash-cli -datadir=/tmp/regtest-datadir generate 3
[
  &quot;05040271f43f78e3870a88697eba201aa361ea5802c69eadaf920ff376787242&quot;,
  &quot;0469f2df43dda69d521c482679b2db3c637b1721222511302584ac75e057c859&quot;,
  &quot;0ab7a26e7b3b5dfca077728de90da0cfd1c49e1edbc130a52de4062b1aecac75&quot;
]
$ src/zcash-cli -datadir=/tmp/regtest-datadir getblockchaininfo
{
  &quot;chain&quot;: &quot;regtest&quot;,
  &quot;blocks&quot;: 3,
  &quot;initial_block_download_complete&quot;: true,
  &quot;headers&quot;: 3,
  (...)
}
$ src/zcash-cli -datadir=/tmp/regtest-datadir stop
Zcash server stopping
$ 
</code></pre>
<h2 id="network-upgrades"><a class="header" href="#network-upgrades">Network upgrades</a></h2>
<p>Zcash has adopted a series of
<a href="https://github.com/zcash/zcash/blob/master/src/consensus/upgrades.cpp">network upgrades</a>.
On <code>mainnet</code> and <code>testnet</code>, these activate at
fixed, known block heights (<a href="https://github.com/zcash/zcash/blob/master/src/chainparams.cpp#L117">example</a>).
In <code>regtest</code> mode, you determine the activation heights. Upgrades may occur at
any height greater than 0, and multiple upgrades can occur at the same height. The upgrades
have a strict ordering (as shown in the upgrades source file); for example, Canopy can't
be activated before Blossom. </p>
<p>You specify the upgrade heights using multiple <code>-nuparams=</code><em>&lt;branch-id&gt;</em> arguments.
(The branch IDs are available in the
<a href="https://github.com/zcash/zcash/blob/master/src/consensus/upgrades.cpp">upgrades.cpp file</a>)
It's convenient to add these to the configuration file, for example:</p>
<pre><code>$ cat &lt;&lt;EOF &gt;&gt;/tmp/regtest-datadir/zcash.conf
nuparams=76b809bb:1
nuparams=f5b9230b:5
EOF
</code></pre>
<p>(Alternatively, you can specify these on the <code>zcashd</code> command line.)
You need not activate every upgrade explicitly. The example activates Sapling
(branchID 76b809bb) at height 1; activating Sapling implies activating Overwinter, so this
is done automatically. Similarly, activating Heartwood at height 5
also simultaneously activates Blossom. Since no later upgrades are specified, none
of them will activate, regardless of height reached.</p>
<p><strong>IMPORTANT</strong>: if you change the network upgrade heights from one
test run to the next, it's almost always necessary to start fresh
by removing the data directory, otherwise you'll encounter strange errors.</p>
<p>You can see which network upgrades are currently active and which are pending
(using the above <code>nuparams</code> settings as an example):</p>
<pre><code>$ src/zcash-cli -datadir=/tmp/regtest-datadir generate 2
$ src/zcash-cli -datadir=/tmp/regtest-datadir getblockchaininfo
{
  &quot;blocks&quot;: 2,
  (...)
    &quot;upgrades&quot;: {
    &quot;5ba81b19&quot;: {
      &quot;name&quot;: &quot;Overwinter&quot;,
      &quot;activationheight&quot;: 1,
      &quot;status&quot;: &quot;active&quot;,
      &quot;info&quot;: &quot;See https://z.cash/upgrade/overwinter/ for details.&quot;
    },
    &quot;76b809bb&quot;: {
      &quot;name&quot;: &quot;Sapling&quot;,
      &quot;activationheight&quot;: 1,
      &quot;status&quot;: &quot;active&quot;,
      &quot;info&quot;: &quot;See https://z.cash/upgrade/sapling/ for details.&quot;
    },
    &quot;2bb40e60&quot;: {
      &quot;name&quot;: &quot;Blossom&quot;,
      &quot;activationheight&quot;: 5,
      &quot;status&quot;: &quot;pending&quot;,
      &quot;info&quot;: &quot;See https://z.cash/upgrade/blossom/ for details.&quot;
    },
    &quot;f5b9230b&quot;: {
      &quot;name&quot;: &quot;Heartwood&quot;,
      &quot;activationheight&quot;: 5,
      &quot;status&quot;: &quot;pending&quot;,
      &quot;info&quot;: &quot;See https://z.cash/upgrade/heartwood/ for details.&quot;
    }
  },
  (...)
}
</code></pre>
<h2 id="manual-testing-within-an-rpc-python-test-run"><a class="header" href="#manual-testing-within-an-rpc-python-test-run">Manual testing within an RPC (Python) test run</a></h2>
<p>It is often useful, either when debugging an issue or simply when you want to put
the node into a certain state, to use the RPC test framework to produce the desired
state and then be able to manually interrogate and modify that state using <code>zcash-cli</code> 
to execute RPC calls. An easy way to do that is as follows:</p>
<p>Add the line <code>import time; time.sleep(999999)</code> (the units are seconds) somewhere
within an RPC test to pause its execution at that point. Start the test, and then:</p>
<pre><code>$ ps alx | grep zcashd
0  1000   96247   96246  20   0 1426304 123952 futex_ SLl+ pts/12   0:18 /g/zcash/src/zcashd -datadir=/tmp/test9d907s8a/96246/node0 -keypool=1 -discover=0 -rest -nuparams=5ba81b19:1 -nuparams=76b809bb:1 -debug=mempool -mempooltxcostlimit=8000
0  1000   96274   96246  20   0 744092 85568 -      RLl+ pts/12     0:05 /g/zcash/src/zcashd -datadir=/tmp/test9d907s8a/96246/node1 -keypool=1 -discover=0 -rest -nuparams=5ba81b19:1 -nuparams=76b809bb:1 -debug=mempool -mempooltxcostlimit=8000
$ 
</code></pre>
<p>Now you can interact with the running test node by copy-and-pasting its
<code>-datadir</code> argument, for example:</p>
<pre><code>$ src/zcash-cli -datadir=/tmp/test9d907s8a/96246/node0 getblockchaininfo
</code></pre>
<p>(The other <code>zcashd</code> command-line arguments are generally not needed by
<code>zcash-cli</code>.) You can see the running node's debug log file:</p>
<pre><code>$ cat /tmp/test9d907s8a/96246/node0/regtest/debug.log
</code></pre>
<p>or look at its configuration file.</p>
<pre><code>$ cat /tmp/test9d907s8a/96246/node0/zcash.conf
</code></pre>
<p>In this way, the RPC test framework can teach us more about running <code>regtest</code> nodes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deprecation-procedure"><a class="header" href="#deprecation-procedure">Deprecation Procedure</a></h1>
<p>From time to time, features of <code>zcashd</code> and its associated wallet and RPC API are
deprecated to allow eventual removal of functionality that has been superseded
by more recent improvements. Deprecation follows a process whereby deprecate
features can be explicitly turned on or off using the
<code>-allowdeprecated=&lt;feature&gt;</code> CLI argument.</p>
<p><code>zcashd</code> internally supports two sets of deprecated feature flags in
<code>src/deprecation.h</code>:</p>
<ul>
<li><code>DEFAULT_ALLOW_DEPRECATED</code> contains the set of features that remain available
for use without having to be specifically enabled using <code>-allowdeprecated</code>.</li>
<li><code>DEFAULT_DENY_DEPRECATED</code> contains the set of features that are not enabled
by default, and must be explicitly enabled using <code>-allowdeprecated</code>.</li>
</ul>
<p>Deprecation of a feature occurs as a 3-step process:</p>
<ol>
<li>A deprecation flag is selected for the feature, and added to
<code>DEFAULT_ALLOW_DEPRECATED</code>. The fact of its deprecation is announced, and
any functionality that supersedes the deprecated feature (if any) is
documented, in the release notes. The string <code>DEPRECATED</code> is added to
user-facing API documentation and CLI help text.</li>
<li>The deprecation flag is removed from <code>DEFAULT_ALLOW_DEPRECATED</code> and added to
<code>DEFAULT_DENY_DEPRECATED</code>.</li>
<li>The deprecated feature is removed entirely, and its deprecation flag is
removed.</li>
</ol>
<p>Features that enter Stage 1 in a particular release should be disabled by
default after no fewer than 3 releases that update <code>zcashd</code>'s
minor-version, and features should only be fully removed after a total of 6 minor-version
updates. <code>zcashd</code>'s release schedule intends to produce a release that updates
the minor version every 6 weeks, so deprecated features remain accessible by
default for approximately 18 weeks, and then can be expected to be removed no
less than 36 weeks from their initial deprecation. The deprecation timeline for
each newly deprecated feature should be documented in
<a href="dev/../user/deprecation.html">../user/deprecation.md</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design"><a class="header" href="#design">Design</a></h1>
<p>Zcash was originally a fork of Bitcoin 0.11.2, and as such the <code>zcashd</code> node architecture
is very similar to <code>bitcoind</code>. There are however several differences, most notably the
addition of shielded pools to the consensus logic and full node state.</p>
<p>In this section of the book, we describe the overall architecture that we inherit from
<code>bitcoind</code>, the changes we have made to the inherited components, and the new components
we have introduced.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chain-state"><a class="header" href="#chain-state">Chain state</a></h1>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coins-view"><a class="header" href="#coins-view">&quot;Coins&quot; view</a></h1>
<p>TBD</p>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<ul>
<li>This is the main context in which <code>CTxOut::IsNull()</code> is used. The other is a
single spot in the mempool code. Once we've backported the
<a href="https://github.com/bitcoin/bitcoin/pull/10195">per-txout CoinsDB</a> we can
hopefully eliminate this method.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="p2p-data-propagation"><a class="header" href="#p2p-data-propagation">P2P data propagation</a></h1>
<p>This page contains notes about how block and transaction data is tracked and propagated by
<code>zcashd</code>. Most of this behaviour is inherited from Bitcoin Core, but some differences have
developed.</p>
<p>Some of this content is duplicated from in-code comments, but assembling this summary in
one place is generally useful for understanding the overall dynamic :)</p>
<h2 id="recentrejects"><a class="header" href="#recentrejects"><code>recentRejects</code></a></h2>
<p>When a transaction is rejected by <code>AcceptToMemoryPool</code>, the transaction is added to the
<code>recentRejects</code> Bloom filter, so that we don't process it again. The Bloom filter resets
whenever the chain tip changes, as previously invalid transactions might become valid.</p>
<p>To prevent DoS attacks against wallets submitting transactions, <code>recentRejects</code> needs to
store a commitment to the entire transaction. This ensures that if a transaction is
malleated by a network peer to invalidate its authorizing data, the node will ignore
future advertisements of that specific transaction, but still request alternative versions
of the same txid (which might have valid authorizing data).</p>
<ul>
<li>For pre-v5 transactions, the txid commits to the entire transaction, and the wtxid is
the txid with a globally-fixed (all-ones) suffix.</li>
<li>For v5+ transactions, the wtxid commits to the entire transaction.</li>
</ul>
<h2 id="maporphantransactions"><a class="header" href="#maporphantransactions"><code>mapOrphanTransactions</code></a></h2>
<p>Upstream uses this map to store transactions that are rejected by <code>AcceptToMemoryPool</code>
because the node doesn't have their transparent inputs. <code>zcashd</code> inherits this behaviour
but limits it to purely-transparent transactions (that is, if a transaction contains any
shielded components, the node rejects it as invalid and adds it to <code>recentRejects</code>).</p>
<p><code>mapOrphanTransactions</code> indexes transactions by txid. This means that if an orphan
transaction is received (spending transparent UTXOs the node does not know about), and it
also happens to be invalid for other reasons (subsequent <code>AcceptToMemoryPool</code> rules that
haven't yet been checked), then the node will not request any v5+ transactions with the
same txid but different authorizing data. This does not create a DoS problem for wallets,
because an adversary that manipulated an orphan transaction to be invalid under the above
constraints would also need to prevent the orphan's parent from entering the mempool, and
eventually a parent is reached that is not an orphan. Once the orphan's direct parent is
accepted, the orphan is re-evaluated, and if it had been manipulated to be invalid, its
wtxid is added to <code>recentRejects</code> while its txid is removed from <code>mapOrphanTransactions</code>,
enabling the wallet to rebroadcast the unmodified transaction.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
